name: .NET CI Test Runner

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches: 
      - master
      - dev
  workflow_dispatch:

jobs:
  build-and-run-test:
    runs-on: ubuntu-latest
    permissions:
        contents: write
    steps:
    - name: Try checkout (head_ref)
      id: checkout_try
      continue-on-error: true
      uses: actions/checkout@v4
      with:
        repository: motuen66/intervu-fe
        ref: ${{ github.head_ref || github.ref_name }}
        path: intervu-fe

    - name: Clean folder if checkout failed
      if: steps.checkout_try.outcome == 'failure'
      run: rm -rf intervu-fe

    - name: Checkout fallback (base_ref)
      if: steps.checkout_try.outcome == 'failure'
      uses: actions/checkout@v4
      with:
        repository: motuen66/intervu-fe
        ref: ${{ github.base_ref || github.ref_name }}
        path: intervu-fe

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: intervu-fe/package-lock.json
    
    - name: Install frontend deps
      run: npm ci
      working-directory: intervu-fe

    - name: Start Vite dev server
      run: |
        npm run dev &
      working-directory: intervu-fe
      env:
        VITE_APP_BE_BASE_URL: ${{ secrets.VITE_APP_BE_BASE_URL }}
        VITE_APP_API_KEY: ${{ secrets.VITE_APP_API_KEY }}
        VITE_LOCAL_HTTPS: ${{ secrets.VITE_LOCAL_HTTPS }}
        VITE_DEV_PFX_PASSPHRASE: ${{ secrets.VITE_DEV_PFX_PASSPHRASE }}

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: intervu-be

    - name: Setup .NET 8 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install SSL Certificates
      run: |
        dotnet dev-certs https --clean
        dotnet dev-certs https --trust

    - name: Write appsettings.Development.json
      shell: pwsh
      run: |
        [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.APPSETTINGS_JSON_BASE64 }}")) | Set-Content intervu-be/Intervu.API/appsettings.Development.json -NoNewline

    - name: Write appsettings.Testing.json
      shell: pwsh
      run: |
        [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.APPSETTINGS_JSON_BASE64_TESTING }}")) | Set-Content intervu-be/Intervu.API/appsettings.Testing.json -NoNewline

    - name: Write firebase.json
      shell: pwsh
      run: |
        [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.FIREBASE_JSON }}")) | Set-Content intervu-be/Intervu.API/firebase.json -NoNewline
    
    - name: Restore dependencies
      run: |
        cd ./intervu-be
        dotnet restore

    - name: Build solution
      run: |
        cd ./intervu-be
        dotnet build --no-restore --configuration Release

    - name: Run API
      env:
        Firebase__CredentialPath: ${{ github.workspace }}/intervu-be/Intervu.API/firebase.json
        Firebase__StorageBucket: ${{ secrets.FIREBASE__STORAGEBUCKET }}
      run: |
        dotnet run --launch-profile "Testing" --no-build --project intervu-be/Intervu.API/Intervu.API.csproj --configuration Release &

    - name: Wait for API
      run: |
        for i in {1..30}; do
          if curl -sf "http://localhost:5293/swagger/v1/swagger.json" -o /dev/null; then
            echo "API ready ‚úÖ"
            exit 0
          fi
          sleep 2
        done
        echo "API failed to start ‚ùå"
        exit 1

    - name: Run tests
      id: test_step
      continue-on-error: true
      env:
        ASPNETCORE_ENVIRONMENT: Testing
        PLAYWRIGHT_HEADLESS: "true"
        Firebase__CredentialPath: ${{ github.workspace }}/intervu-be/Intervu.API/firebase.json
      run: |
        cd ./intervu-be
        dotnet test --verbosity minimal --no-build --configuration Release --blame --blame-hang --blame-hang-timeout 5m -- RunConfiguration.DisableParallelization=true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ./intervu-be/Intervu.API.Test/bin/Release/net8.0/TestResults/ExtentReport.html

    - name: Prepare Pages content
      if: always()
      run: |
        REPORT_PATH="./intervu-be/Intervu.API.Test/bin/Release/net8.0/TestResults/ExtentReport.html"

        if [ ! -f "$REPORT_PATH" ]; then
          echo "Test report not found, skipping publish"
          exit 0
        fi

        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"

        mkdir -p public/$BRANCH_NAME
        cp "$REPORT_PATH" "./public/$BRANCH_NAME/index.html"

        # Ensure root index exists (prevents gh-pages glob error)
        touch public/.nojekyll

    - name: Deploy to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: ./public
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'

    # - name: Checkout gh-pages branch (create if missing)
    #   if: always()
    #   uses: actions/checkout@v4
    #   with:
    #     ref: gh-pages
    #     path: gh-pages
    #     fetch-depth: 0

    # - name: Ensure gh-pages branch exists
    #   if: always()
    #   run: |
    #     git fetch origin
    #     if ! git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
    #       git checkout --orphan gh-pages
    #       git rm -rf .
    #       echo "<h1>GitHub Pages initialized</h1>" > index.html
    #       git add index.html
    #       git commit -m "Initialize gh-pages"
    #       git push origin gh-pages
    #       git checkout -
    #     fi

    # - name: Save test report to GitHub Pages (by branch)
    #   if: always()
    #   run: |
    #     BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
    #     TARGET_DIR="gh-pages/${BRANCH_NAME}"

    #     mkdir -p "$TARGET_DIR"
    #     cp ./intervu-be/Intervu.API.Test/bin/Release/net8.0/TestResults/ExtentReport.html \
    #        "$TARGET_DIR/index.html"

    # - name: Commit and push report
    #   if: always()
    #   run: |
    #     cd gh-pages
    #     git config user.name "github-actions[bot]"
    #     git config user.email "github-actions[bot]@users.noreply.github.com"

    #     git add .
    #     git commit -m "Update report for ${{ github.ref_name }}" || echo "No changes"
    #     git push origin gh-pages

    - name: Show GitHub Pages URL
      if: always()
      run: |
        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
        echo "Test report URL:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_NAME}/"

    - name: Add report URL to job summary
      if: always()
      run: |
        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_NAME}/"

        {
          echo "## üß™ Test Report"
          echo ""
          echo "- **Branch:** \`${{ github.ref_name }}\`"
          echo "- **Report:** [$REPORT_URL]($REPORT_URL)"
        } >> "$GITHUB_STEP_SUMMARY"

    - name: Fail job if tests failed
      if: steps.test_step.outcome == 'failure'
      run: |
        echo "Tests failed ‚ùå"
        exit 1
